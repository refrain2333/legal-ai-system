# ä»»åŠ¡1ï¼šå®æ–½ç¬¬ä¸€é˜¶æ®µ - æ··åˆæœç´¢ + æ•°æ®è´¨é‡ä¿è¯

**ç›®æ ‡**: å®æ–½BM25å…³é”®è¯æœç´¢ä¸Lawformerè¯­ä¹‰æœç´¢çš„æ··åˆæ¶æ„ï¼ŒåŒæ—¶ç¡®ä¿è¯„ä¼°æ•°æ®çš„è´¨é‡ï¼Œä¸ºAIé›†æˆå¥ å®šåšå®åŸºç¡€ã€‚

**å…³è”æ–‡æ¡£**: `docs/ä¼˜åŒ–/æ³•æ™ºå¯¼èˆª_æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥æ¦‚è§ˆ.md`

**é¢„è®¡ç”¨æ—¶**: 4å¤©

**æ ¸å¿ƒç†å¿µ**: "æ··åˆæœç´¢"ä¿ä¸‹é™ï¼Œç«‹ç«¿è§å½±æå‡å…³é”®è¯åŒ¹é…èƒ½åŠ›

---

## æ ¸å¿ƒå·¥ä½œåˆ†è§£ (WBS)

### 1. Ground Truth è´¨é‡å®¡æ ¸ (1.5å¤©) - ä¼˜å…ˆçº§ğŸ”¥

#### ä»»åŠ¡1.1: æ•°æ®è´¨é‡æŠ½æ ·å¤æ ¸
- [ ] **ä»»åŠ¡**: å¯¹ç”¨äºè¯„ä¼°æ¨¡å‹æ€§èƒ½çš„"æ ‡å‡†ç­”æ¡ˆ"è¿›è¡Œè´¨é‡æ£€æŸ¥ï¼Œç¡®ä¿è¯„ä¼°æŒ‡æ ‡å¯ä¿¡ã€‚
- **å½±å“æ–‡ä»¶**: `evaluation/data/ground_truth.py`
- **å®æ–½æ­¥éª¤**:
  - [ ] ä»è¯„ä¼°æ•°æ®é›†ä¸­ï¼ŒéšæœºæŠ½å– **20-30** ä¸ª"æ¡ˆä¾‹â†’æ³•æ¡"çš„æµ‹è¯•ç”¨ä¾‹
  - [ ] **äººå·¥å®¡æ ¸**: é€ä¸€åˆ¤æ–­æ¯ä¸ªæ¡ˆä¾‹æ‰€å…³è”çš„æ³•æ¡æ˜¯å¦å‡†ç¡®ã€å®Œæ•´ï¼Œæ˜¯å¦å­˜åœ¨é—æ¼æˆ–é”™è¯¯å…³è”
  - [ ] **äº§å‡ºæŠ¥å‘Š**: å°†å®¡æ ¸ç»“æœè®°å½•åœ¨ `docs/tasks/reports/ground_truth_review_report.md`

#### ä»»åŠ¡1.2: åˆ›å»ºæ•°æ®éªŒè¯å·¥å…·
- [ ] **åˆ›å»º**: `tools/data_validation/ground_truth_validator.py`
- **åŠŸèƒ½**:
  ```python
  class GroundTruthValidator:
      def random_sample_for_review(self, sample_size: int = 20)
      def analyze_validation_results(self, validation_file: str)
      def generate_quality_report(self) -> Dict
  ```

### 2. BM25å…³é”®è¯æœç´¢å®ç° (1.5å¤©)

#### ä»»åŠ¡2.1: å®‰è£…ä¾èµ–å’Œç¯å¢ƒå‡†å¤‡
- [ ] **å®‰è£…**: `pip install rank-bm25`
- [ ] **éªŒè¯**: ç¡®ä¿å¼€å‘ç¯å¢ƒæ”¯æŒBM25ç´¢å¼•æ„å»º

#### ä»»åŠ¡2.2: BM25ç´¢å¼•æ„å»º
- [ ] **ä¿®æ”¹æ–‡ä»¶**: `src/infrastructure/storage/data_loader.py`
- **æ ¸å¿ƒåŠŸèƒ½**:
  ```python
  def _build_bm25_index(self):
      # æ”¶é›†æ‰€æœ‰æ³•æ¡å’Œæ¡ˆä¾‹æ–‡æ¡£
      tokenized_corpus = []
      doc_ids = []

      # æ³•æ¡æ–‡æ¡£å¤„ç†
      for article in self.get_all_articles():
          content = f"{article.title} {article.content}"
          tokenized_corpus.append(content.split())
          doc_ids.append(f"article_{article.article_number}")

      # æ¡ˆä¾‹æ–‡æ¡£å¤„ç†
      for case in self.get_all_cases():
          content = case.fact or ""
          tokenized_corpus.append(content.split())
          doc_ids.append(f"case_{case.case_id}")

      self.bm25_index = BM25Okapi(tokenized_corpus)
      self.bm25_doc_ids = doc_ids
  ```

#### ä»»åŠ¡2.3: BM25æœç´¢æ–¹æ³•å®ç°
- [ ] **åœ¨data_loader.pyä¸­æ·»åŠ **:
  ```python
  def bm25_search(self, query: str, top_k: int = 20) -> List[Dict]:
      """BM25å…³é”®è¯æœç´¢"""
      tokenized_query = query.split()
      scores = self.bm25_index.get_scores(tokenized_query)
      top_indices = scores.argsort()[-top_k:][::-1]

      results = []
      for idx in top_indices:
          if scores[idx] > 0:
              results.append({
                  'id': self.bm25_doc_ids[idx],
                  'similarity': float(scores[idx]),
                  'source': 'bm25'
              })
      return results
  ```

### 3. æ··åˆæœç´¢æ¶æ„å®ç° (1å¤©)

#### ä»»åŠ¡3.1: ç»“æœèåˆç®—æ³• (RRF)
- [ ] **ä¿®æ”¹æ–‡ä»¶**: `src/infrastructure/search/vector_search_engine.py`
- **å®ç°RRFèåˆ**:
  ```python
  def _reciprocal_rank_fusion(self, results_lists: List[List], k: int = 60) -> List[Tuple]:
      """å€’æ•°æ’åèåˆç®—æ³•"""
      fused_scores = {}
      for doc_list in results_lists:
          for rank, doc_id in enumerate(doc_list):
              if doc_id not in fused_scores:
                  fused_scores[doc_id] = 0
              fused_scores[doc_id] += 1 / (k + rank + 1)

      return sorted(fused_scores.items(), key=lambda x: x[1], reverse=True)
  ```

#### ä»»åŠ¡3.2: æ··åˆæœç´¢ä¸»æ–¹æ³•
- [ ] **åœ¨vector_search_engine.pyä¸­å®ç°**:
  ```python
  def hybrid_search(self, query: str, top_k: int = 20) -> List[Dict]:
      """æ··åˆæœç´¢ä¸»å…¥å£"""
      try:
          # 1. Lawformerè¯­ä¹‰æœç´¢
          semantic_results = self.search(query, top_k * 2, include_content=True)

          # 2. BM25å…³é”®è¯æœç´¢
          bm25_results = self.data_loader.bm25_search(query, top_k * 2)

          # 3. RRFèåˆ
          fused_results = self._reciprocal_rank_fusion([
              [r['id'] for r in semantic_results],
              [r['id'] for r in bm25_results]
          ])

          # 4. æ„é€ æœ€ç»ˆç»“æœ
          return self._build_final_results(fused_results[:top_k], semantic_results, bm25_results)

      except Exception as e:
          logger.error(f"æ··åˆæœç´¢å¤±è´¥: {e}")
          # é™çº§åˆ°çº¯è¯­ä¹‰æœç´¢
          return self.search(query, top_k, include_content=True)
  ```

### 4. æœåŠ¡å±‚é›†æˆ (1å¤©)

#### ä»»åŠ¡4.1: æœç´¢æœåŠ¡æ›´æ–°
- [ ] **ä¿®æ”¹æ–‡ä»¶**: `src/services/search_service.py`
- **é›†æˆæ··åˆæœç´¢**:
  ```python
  async def search_documents_mixed(self, query_text: str, articles_count: int = 5, cases_count: int = 5):
      """å¢å¼ºç‰ˆæ··åˆæœç´¢"""
      start_time = time.time()

      try:
          # ä½¿ç”¨æ··åˆæœç´¢å¼•æ“
          if hasattr(self.repository.search_engine, 'hybrid_search'):
              raw_results = self.repository.search_engine.hybrid_search(
                  query_text,
                  top_k=(articles_count + cases_count) * 2
              )
          else:
              # é™çº§åˆ°åŸå§‹æœç´¢
              raw_results = self.repository.search_engine.search(
                  query_text, top_k=(articles_count + cases_count) * 2
              )

          # åˆ†ç¦»æ³•æ¡å’Œæ¡ˆä¾‹ç»“æœ
          articles_results = [r for r in raw_results if 'article' in r['id']][:articles_count]
          cases_results = [r for r in raw_results if 'case' in r['id']][:cases_count]

          # è½¬æ¢ä¸ºé¢†åŸŸå¯¹è±¡
          domain_articles = await self._convert_to_domain_objects(articles_results)
          domain_cases = await self._convert_to_domain_objects(cases_results)

          end_time = time.time()
          return {
              'success': True,
              'articles': domain_articles,
              'cases': domain_cases,
              'total_articles': len(domain_articles),
              'total_cases': len(domain_cases),
              'query': query_text,
              'search_context': {
                  'duration_ms': round((end_time - start_time) * 1000, 2),
                  'hybrid_search_used': True,
                  'fusion_method': 'RRF'
              }
          }

      except Exception as e:
          logger.error(f"æ··åˆæœç´¢å¤±è´¥: {e}")
          return await self._fallback_search_mixed(query_text, articles_count, cases_count)
  ```

#### ä»»åŠ¡4.2: é…ç½®æ›´æ–°
- [ ] **ä¿®æ”¹**: `src/config/settings.py`
  ```python
  class Settings(BaseSettings):
      # æ··åˆæœç´¢é…ç½®
      enable_hybrid_search: bool = True
      bm25_weight: float = 0.4
      semantic_weight: float = 0.6
      rrf_k_parameter: int = 60
  ```

## æµ‹è¯•ä¸éªŒè¯

### å•å…ƒæµ‹è¯•
- [ ] **åˆ›å»º**: `tests/test_hybrid_search.py`
- **æµ‹è¯•ç”¨ä¾‹**:
  ```python
  def test_bm25_search():
      # æµ‹è¯•BM25å…³é”®è¯æœç´¢
      pass

  def test_hybrid_search():
      # æµ‹è¯•æ··åˆæœç´¢ç»“æœ
      pass

  def test_rrf_fusion():
      # æµ‹è¯•ç»“æœèåˆç®—æ³•
      pass
  ```

### æ•ˆæœéªŒè¯
- [ ] **è¿è¡Œè¯„ä¼°**: `python evaluation/run_evaluation.py --quick`
- **é¢„æœŸæ•ˆæœ**: ç»¼åˆå¾—åˆ†ä»26.41% â†’ **35%+**

### æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] **æµ‹è¯•æŸ¥è¯¢**:
  ```python
  test_queries = [
      "ç›—çªƒç½ªåˆ¤å¤šå°‘å¹´",        # æ˜ç¡®ç½ªå
      "ç¬¬264æ¡è§„å®šä»€ä¹ˆ",      # æ˜ç¡®æ³•æ¡
      "å·ä¸œè¥¿è¢«æŠ“æ€ä¹ˆåŠ",      # å£è¯­åŒ–æŸ¥è¯¢
      "äº¤é€šè‚‡äº‹é€ƒé€¸é‡åˆ‘"       # å¤åˆæ¦‚å¿µ
  ]
  ```

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] BM25ç´¢å¼•æ„å»ºæˆåŠŸï¼Œèƒ½æ­£å¸¸æ‰§è¡Œå…³é”®è¯æœç´¢
- [ ] æ··åˆæœç´¢åŠŸèƒ½æ­£å¸¸ï¼ŒRRFèåˆç®—æ³•å·¥ä½œæ­£ç¡®
- [ ] æœåŠ¡å±‚é›†æˆå®Œæ¯•ï¼ŒAPIå“åº”æ­£å¸¸
- [ ] Ground Truthè´¨é‡å®¡æ ¸å®Œæˆï¼Œç”Ÿæˆè´¨é‡æŠ¥å‘Š

### æ€§èƒ½éªŒæ”¶
- [ ] æ··åˆæœç´¢å“åº”æ—¶é—´ < 100ms
- [ ] å…³é”®è¯ç²¾ç¡®åŒ¹é…æŸ¥è¯¢å‡†ç¡®ç‡æ˜æ˜¾æå‡
- [ ] ç»¼åˆè¯„ä¼°å¾—åˆ† > 35%
- [ ] ç³»ç»Ÿç¨³å®šæ€§ä¿æŒï¼Œæ— æ€§èƒ½é€€åŒ–

### ä»£ç è´¨é‡
- [ ] æ–°å¢ä»£ç é€šè¿‡å•å…ƒæµ‹è¯•
- [ ] ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
- [ ] æ·»åŠ é€‚å½“çš„æ—¥å¿—è®°å½•
- [ ] å®ç°é™çº§æœºåˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿå¥å£®æ€§

## é£é™©æ§åˆ¶

### æ½œåœ¨é£é™©
1. **BM25ç´¢å¼•æ„å»ºæ—¶é—´**: 17,131ä¸ªæ¡ˆä¾‹å¯èƒ½éœ€è¦è¾ƒé•¿æ„å»ºæ—¶é—´
2. **å†…å­˜å ç”¨**: BM25ç´¢å¼•å’ŒåŸæœ‰å‘é‡æ•°æ®åŒé‡å ç”¨
3. **ç»“æœè´¨é‡**: èåˆç®—æ³•å‚æ•°éœ€è¦è°ƒä¼˜

### åº”å¯¹æªæ–½
1. **å¼‚æ­¥æ„å»º**: åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶åå°æ„å»ºç´¢å¼•
2. **å†…å­˜ç›‘æ§**: ç›‘æ§å†…å­˜ä½¿ç”¨ï¼Œå¿…è¦æ—¶ä¼˜åŒ–æ•°æ®ç»“æ„
3. **å‚æ•°è°ƒä¼˜**: æä¾›é…ç½®é€‰é¡¹ï¼Œæ”¯æŒè¿è¡Œæ—¶è°ƒæ•´æƒé‡
4. **é™çº§ç­–ç•¥**: ä»»ä½•ç»„ä»¶å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°åŸå§‹æœç´¢

## ä¸‹ä¸€æ­¥å‡†å¤‡

å®Œæˆç¬¬ä¸€é˜¶æ®µåï¼Œä¸ºç¬¬äºŒé˜¶æ®µAIå¢å¼ºåšå‡†å¤‡ï¼š
- [ ] ç”³è¯·OpenAI APIå¯†é’¥ (ç”¨äºQuery2docå’ŒHyDE)
- [ ] å‡†å¤‡Google Gemini APIå¤‡é€‰æ–¹æ¡ˆ
- [ ] è®¾è®¡AIè°ƒç”¨çš„é”™è¯¯å¤„ç†å’Œé™çº§æœºåˆ¶

---

**æˆåŠŸæ ‡å¿—**: å½“ç”¨æˆ·æŸ¥è¯¢"ç›—çªƒç½ªç¬¬264æ¡"æ—¶ï¼Œç³»ç»Ÿèƒ½åŒæ—¶åŒ¹é…åˆ°åŒ…å«"ç›—çªƒ"å…³é”®è¯çš„æ¡ˆä¾‹å’Œç¬¬264æ¡æ³•æ¡ï¼Œå¹¶é€šè¿‡RRFç®—æ³•ç»™å‡ºç§‘å­¦æ’åºçš„æ··åˆç»“æœã€‚