# 任务1：实施第一阶段 - 混合搜索 + 数据质量保证

**目标**: 实施BM25关键词搜索与Lawformer语义搜索的混合架构，同时确保评估数据的质量，为AI集成奠定坚实基础。

**关联文档**: `docs/优化/法智导航_核心优化策略概览.md`

**预计用时**: 4天

**核心理念**: "混合搜索"保下限，立竿见影提升关键词匹配能力

---

## 核心工作分解 (WBS)

### 1. Ground Truth 质量审核 (1.5天) - 优先级🔥

#### 任务1.1: 数据质量抽样复核
- [ ] **任务**: 对用于评估模型性能的"标准答案"进行质量检查，确保评估指标可信。
- **影响文件**: `evaluation/data/ground_truth.py`
- **实施步骤**:
  - [ ] 从评估数据集中，随机抽取 **20-30** 个"案例→法条"的测试用例
  - [ ] **人工审核**: 逐一判断每个案例所关联的法条是否准确、完整，是否存在遗漏或错误关联
  - [ ] **产出报告**: 将审核结果记录在 `docs/tasks/reports/ground_truth_review_report.md`

#### 任务1.2: 创建数据验证工具
- [ ] **创建**: `tools/data_validation/ground_truth_validator.py`
- **功能**:
  ```python
  class GroundTruthValidator:
      def random_sample_for_review(self, sample_size: int = 20)
      def analyze_validation_results(self, validation_file: str)
      def generate_quality_report(self) -> Dict
  ```

### 2. BM25关键词搜索实现 (1.5天)

#### 任务2.1: 安装依赖和环境准备
- [ ] **安装**: `pip install rank-bm25`
- [ ] **验证**: 确保开发环境支持BM25索引构建

#### 任务2.2: BM25索引构建
- [ ] **修改文件**: `src/infrastructure/storage/data_loader.py`
- **核心功能**:
  ```python
  def _build_bm25_index(self):
      # 收集所有法条和案例文档
      tokenized_corpus = []
      doc_ids = []

      # 法条文档处理
      for article in self.get_all_articles():
          content = f"{article.title} {article.content}"
          tokenized_corpus.append(content.split())
          doc_ids.append(f"article_{article.article_number}")

      # 案例文档处理
      for case in self.get_all_cases():
          content = case.fact or ""
          tokenized_corpus.append(content.split())
          doc_ids.append(f"case_{case.case_id}")

      self.bm25_index = BM25Okapi(tokenized_corpus)
      self.bm25_doc_ids = doc_ids
  ```

#### 任务2.3: BM25搜索方法实现
- [ ] **在data_loader.py中添加**:
  ```python
  def bm25_search(self, query: str, top_k: int = 20) -> List[Dict]:
      """BM25关键词搜索"""
      tokenized_query = query.split()
      scores = self.bm25_index.get_scores(tokenized_query)
      top_indices = scores.argsort()[-top_k:][::-1]

      results = []
      for idx in top_indices:
          if scores[idx] > 0:
              results.append({
                  'id': self.bm25_doc_ids[idx],
                  'similarity': float(scores[idx]),
                  'source': 'bm25'
              })
      return results
  ```

### 3. 混合搜索架构实现 (1天)

#### 任务3.1: 结果融合算法 (RRF)
- [ ] **修改文件**: `src/infrastructure/search/vector_search_engine.py`
- **实现RRF融合**:
  ```python
  def _reciprocal_rank_fusion(self, results_lists: List[List], k: int = 60) -> List[Tuple]:
      """倒数排名融合算法"""
      fused_scores = {}
      for doc_list in results_lists:
          for rank, doc_id in enumerate(doc_list):
              if doc_id not in fused_scores:
                  fused_scores[doc_id] = 0
              fused_scores[doc_id] += 1 / (k + rank + 1)

      return sorted(fused_scores.items(), key=lambda x: x[1], reverse=True)
  ```

#### 任务3.2: 混合搜索主方法
- [ ] **在vector_search_engine.py中实现**:
  ```python
  def hybrid_search(self, query: str, top_k: int = 20) -> List[Dict]:
      """混合搜索主入口"""
      try:
          # 1. Lawformer语义搜索
          semantic_results = self.search(query, top_k * 2, include_content=True)

          # 2. BM25关键词搜索
          bm25_results = self.data_loader.bm25_search(query, top_k * 2)

          # 3. RRF融合
          fused_results = self._reciprocal_rank_fusion([
              [r['id'] for r in semantic_results],
              [r['id'] for r in bm25_results]
          ])

          # 4. 构造最终结果
          return self._build_final_results(fused_results[:top_k], semantic_results, bm25_results)

      except Exception as e:
          logger.error(f"混合搜索失败: {e}")
          # 降级到纯语义搜索
          return self.search(query, top_k, include_content=True)
  ```

### 4. 服务层集成 (1天)

#### 任务4.1: 搜索服务更新
- [ ] **修改文件**: `src/services/search_service.py`
- **集成混合搜索**:
  ```python
  async def search_documents_mixed(self, query_text: str, articles_count: int = 5, cases_count: int = 5):
      """增强版混合搜索"""
      start_time = time.time()

      try:
          # 使用混合搜索引擎
          if hasattr(self.repository.search_engine, 'hybrid_search'):
              raw_results = self.repository.search_engine.hybrid_search(
                  query_text,
                  top_k=(articles_count + cases_count) * 2
              )
          else:
              # 降级到原始搜索
              raw_results = self.repository.search_engine.search(
                  query_text, top_k=(articles_count + cases_count) * 2
              )

          # 分离法条和案例结果
          articles_results = [r for r in raw_results if 'article' in r['id']][:articles_count]
          cases_results = [r for r in raw_results if 'case' in r['id']][:cases_count]

          # 转换为领域对象
          domain_articles = await self._convert_to_domain_objects(articles_results)
          domain_cases = await self._convert_to_domain_objects(cases_results)

          end_time = time.time()
          return {
              'success': True,
              'articles': domain_articles,
              'cases': domain_cases,
              'total_articles': len(domain_articles),
              'total_cases': len(domain_cases),
              'query': query_text,
              'search_context': {
                  'duration_ms': round((end_time - start_time) * 1000, 2),
                  'hybrid_search_used': True,
                  'fusion_method': 'RRF'
              }
          }

      except Exception as e:
          logger.error(f"混合搜索失败: {e}")
          return await self._fallback_search_mixed(query_text, articles_count, cases_count)
  ```

#### 任务4.2: 配置更新
- [ ] **修改**: `src/config/settings.py`
  ```python
  class Settings(BaseSettings):
      # 混合搜索配置
      enable_hybrid_search: bool = True
      bm25_weight: float = 0.4
      semantic_weight: float = 0.6
      rrf_k_parameter: int = 60
  ```

## 测试与验证

### 单元测试
- [ ] **创建**: `tests/test_hybrid_search.py`
- **测试用例**:
  ```python
  def test_bm25_search():
      # 测试BM25关键词搜索
      pass

  def test_hybrid_search():
      # 测试混合搜索结果
      pass

  def test_rrf_fusion():
      # 测试结果融合算法
      pass
  ```

### 效果验证
- [ ] **运行评估**: `python evaluation/run_evaluation.py --quick`
- **预期效果**: 综合得分从26.41% → **35%+**

### 性能基准测试
- [ ] **测试查询**:
  ```python
  test_queries = [
      "盗窃罪判多少年",        # 明确罪名
      "第264条规定什么",      # 明确法条
      "偷东西被抓怎么办",      # 口语化查询
      "交通肇事逃逸量刑"       # 复合概念
  ]
  ```

## 验收标准

### 功能验收
- [ ] BM25索引构建成功，能正常执行关键词搜索
- [ ] 混合搜索功能正常，RRF融合算法工作正确
- [ ] 服务层集成完毕，API响应正常
- [ ] Ground Truth质量审核完成，生成质量报告

### 性能验收
- [ ] 混合搜索响应时间 < 100ms
- [ ] 关键词精确匹配查询准确率明显提升
- [ ] 综合评估得分 > 35%
- [ ] 系统稳定性保持，无性能退化

### 代码质量
- [ ] 新增代码通过单元测试
- [ ] 代码符合项目规范
- [ ] 添加适当的日志记录
- [ ] 实现降级机制，确保系统健壮性

## 风险控制

### 潜在风险
1. **BM25索引构建时间**: 17,131个案例可能需要较长构建时间
2. **内存占用**: BM25索引和原有向量数据双重占用
3. **结果质量**: 融合算法参数需要调优

### 应对措施
1. **异步构建**: 在系统启动时后台构建索引
2. **内存监控**: 监控内存使用，必要时优化数据结构
3. **参数调优**: 提供配置选项，支持运行时调整权重
4. **降级策略**: 任何组件失败时自动降级到原始搜索

## 下一步准备

完成第一阶段后，为第二阶段AI增强做准备：
- [ ] 申请OpenAI API密钥 (用于Query2doc和HyDE)
- [ ] 准备Google Gemini API备选方案
- [ ] 设计AI调用的错误处理和降级机制

---

**成功标志**: 当用户查询"盗窃罪第264条"时，系统能同时匹配到包含"盗窃"关键词的案例和第264条法条，并通过RRF算法给出科学排序的混合结果。