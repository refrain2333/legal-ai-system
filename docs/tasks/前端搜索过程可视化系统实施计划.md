# å‰ç«¯æœç´¢è¿‡ç¨‹å¯è§†åŒ–ç³»ç»Ÿ - å®Œæ•´å®æ–½è®¡åˆ’

å®ç°AIé©±åŠ¨åˆ‘æ³•æœç´¢ç®¡é“çš„å‰ç«¯å®æ—¶å¯è§†åŒ–ï¼Œè®©ç”¨æˆ·æ¸…æ¥šäº†è§£æœç´¢è¿‡ç¨‹ï¼Œæ–¹ä¾¿å¼€å‘è°ƒè¯•ã€‚

---

## ğŸ¯ é¡¹ç›®ç›®æ ‡

### **ç”¨æˆ·ä»·å€¼**
- **é€æ˜åŒ–**: ç”¨æˆ·èƒ½çœ‹åˆ°AIæ˜¯å¦‚ä½•ç†è§£å’Œå¤„ç†æŸ¥è¯¢çš„
- **ä¸“ä¸šæ€§**: å±•ç¤ºæ³•å¾‹æ£€ç´¢çš„ä¸“ä¸šæµç¨‹
- **ä¿¡ä»»åº¦**: é€šè¿‡è¿‡ç¨‹å¯è§†åŒ–å»ºç«‹ç”¨æˆ·ä¿¡ä»»

### **å¼€å‘ä»·å€¼**
- **è°ƒè¯•ä¾¿åˆ©**: å¿«é€Ÿå®šä½é—®é¢˜æ¨¡å—å’Œæ•°æ®å¼‚å¸¸
- **æ€§èƒ½ç›‘æ§**: å®æ—¶æŸ¥çœ‹å„é˜¶æ®µè€—æ—¶å’ŒæˆåŠŸç‡
- **æ•°æ®éªŒè¯**: éªŒè¯æ¯ä¸ªæ¨¡å—çš„è¾“å…¥è¾“å‡ºæ­£ç¡®æ€§

---

## ğŸ“‹ å®Œæ•´å®æ–½è®¡åˆ’

### **é˜¶æ®µ1: æ•°æ®è§„èŒƒè®¾è®¡ (2å¤©)**

#### 1.1 ç»Ÿä¸€æ•°æ®äº¤ä»˜æ ¼å¼
æ¯ä¸ªæ¨¡å—å¿…é¡»è¿”å›æ ‡å‡†æ ¼å¼çš„è°ƒè¯•ä¿¡æ¯ï¼š

```typescript
interface ModuleOutput {
  module_name: string;           // æ¨¡å—åç§°
  stage: string;                 // å¤„ç†é˜¶æ®µ
  input_data: any;               // è¾“å…¥æ•°æ®
  output_data: any;              // è¾“å‡ºæ•°æ®
  processing_time_ms: number;    // å¤„ç†è€—æ—¶
  success: boolean;              // æ˜¯å¦æˆåŠŸ
  confidence_score?: number;     // ç½®ä¿¡åº¦
  debug_info: {                 // è°ƒè¯•ä¿¡æ¯
    method_used: string;
    fallback_triggered?: boolean;
    error_message?: string;
    internal_steps: string[];
  };
  metadata: {                   // å…ƒæ•°æ®
    timestamp: string;
    module_version: string;
    config_used: any;
  };
}
```

#### 1.2 å®Œæ•´æœç´¢ç®¡é“æ•°æ®æ ¼å¼
è®¾è®¡5é˜¶æ®µå®Œæ•´çš„æ•°æ®æµï¼š

```typescript
interface SearchPipelineTrace {
  request_id: string;
  user_query: string;
  total_duration_ms: number;

  // é˜¶æ®µ1: LLMåˆ†ç±»
  classification: {
    input: string;
    output: {
      is_criminal_law: boolean;
      confidence: number;
      reasoning: string;
      keywords_detected: string[];
    };
    processing_time_ms: number;
    llm_model_used: string;
  };

  // é˜¶æ®µ2: ç»“æ„åŒ–æå– (ä»…åˆ‘æ³•é—®é¢˜)
  extraction?: {
    input: string;
    output: {
      identified_crimes: Array<{
        crime_name: string;
        confidence: number;
        matched_keywords: string[];
      }>;
      query2doc_enhanced: string;
      hyde_hypothetical: string;
      bm25_keywords: string[];
    };
    processing_time_ms: number;
    crimes_list_version: string;
  };

  // é˜¶æ®µ3: æœç´¢è·¯ç”±å†³ç­–
  routing?: {
    input: any;
    output: {
      selected_paths: string[];
      routing_reasoning: string;
      parallel_execution: boolean;
    };
    processing_time_ms: number;
  };

  // é˜¶æ®µ4: å¤šè·¯æœç´¢æ‰§è¡Œ
  searches?: {
    knowledge_graph?: ModuleOutput;
    llm_enhanced?: ModuleOutput;
    bm25_hybrid?: ModuleOutput;
    basic_semantic?: ModuleOutput;
  };

  // é˜¶æ®µ5: èåˆä¸å›ç­”ç”Ÿæˆ
  fusion?: {
    input: any[];
    output: {
      fused_results: any[];
      fusion_algorithm: string;
      confidence_scores: number[];
      final_answer: string;
    };
    processing_time_ms: number;
  };

  // æ•´ä½“ç»Ÿè®¡
  summary: {
    total_modules_used: number;
    successful_modules: number;
    highest_confidence: number;
    processing_mode: "criminal_law" | "general_ai";
  };
}
```

### **é˜¶æ®µ2: åç«¯APIå¢å¼º (3å¤©)**

#### 2.1 æ·»åŠ è°ƒè¯•æ¨¡å¼æ”¯æŒ
```python
# åœ¨SearchServiceä¸­æ·»åŠ 
class SearchService:
    def __init__(self, repository: ILegalDocumentRepository, debug_mode: bool = False):
        self.debug_mode = debug_mode
        self.trace_collector = SearchTraceCollector() if debug_mode else None

    async def search_documents_intelligent(self, query: str, debug: bool = False):
        """æ™ºèƒ½æœç´¢ - æ”¯æŒè°ƒè¯•æ¨¡å¼"""
        if debug or self.debug_mode:
            return await self._search_with_full_trace(query)
        else:
            return await self._search_production_mode(query)
```

#### 2.2 æ¯ä¸ªæ¨¡å—æ·»åŠ traceæ”¶é›†
```python
class LLMClassifier:
    async def classify_query(self, query: str) -> Tuple[dict, ModuleTrace]:
        start_time = time.time()

        # å®é™…å¤„ç†é€»è¾‘
        result = await self._do_classification(query)

        # æ”¶é›†traceä¿¡æ¯
        trace = ModuleTrace(
            module_name="llm_classifier",
            stage="classification",
            input_data={"query": query},
            output_data=result,
            processing_time_ms=(time.time() - start_time) * 1000,
            success=True,
            debug_info={
                "method_used": "gemini-2.5-flash",
                "internal_steps": ["prompt_construction", "llm_call", "response_parsing"],
                "prompt_tokens": 150,
                "response_tokens": 80
            }
        )

        return result, trace
```

#### 2.3 åˆ›å»ºä¸“é—¨çš„è°ƒè¯•APIç«¯ç‚¹
```python
@router.post("/api/search/debug")
async def debug_search(request: DebugSearchRequest):
    """å®Œæ•´è°ƒè¯•æ¨¡å¼æœç´¢ - è¿”å›è¯¦ç»†traceä¿¡æ¯"""

@router.post("/api/search/trace/{request_id}")
async def get_search_trace(request_id: str):
    """è·å–æŒ‡å®šæœç´¢çš„å®Œæ•´traceè®°å½•"""

@router.get("/api/debug/modules/status")
async def get_modules_status():
    """è·å–æ‰€æœ‰æœç´¢æ¨¡å—çš„å½“å‰çŠ¶æ€"""
```

### **é˜¶æ®µ3: å‰ç«¯ç•Œé¢å¼€å‘ (4å¤©)**

#### 3.1 å®æ—¶æœç´¢è¿›åº¦å±•ç¤º
åˆ›å»ºåŠ¨æ€çš„æœç´¢ç®¡é“å¯è§†åŒ–ç•Œé¢ï¼š

```html
<!-- æœç´¢è¿›åº¦æ¡ -->
<div class="search-pipeline">
  <div class="stage" :class="stage1.status">
    <div class="stage-icon">ğŸ¤–</div>
    <div class="stage-name">é—®é¢˜åˆ†ç±»</div>
    <div class="stage-result" v-if="stage1.completed">
      {{ stage1.result.is_criminal_law ? 'åˆ‘æ³•ç›¸å…³' : 'é€šç”¨é—®é¢˜' }}
    </div>
    <div class="stage-time">{{ stage1.duration }}ms</div>
  </div>

  <!-- å…¶ä»–é˜¶æ®µ... -->
</div>
```

#### 3.2 è¯¦ç»†æ•°æ®æŸ¥çœ‹å™¨
```javascript
// Vueç»„ä»¶ - æ•°æ®è¯¦æƒ…é¢æ¿
const DebugPanel = {
  data() {
    return {
      searchTrace: null,
      selectedModule: null,
      realTimeMode: true
    }
  },

  methods: {
    async fetchSearchTrace(requestId) {
      const response = await fetch(`/api/search/trace/${requestId}`);
      this.searchTrace = await response.json();
    },

    showModuleDetails(moduleName) {
      this.selectedModule = this.searchTrace.searches[moduleName];
    },

    formatJson(data) {
      return JSON.stringify(data, null, 2);
    }
  }
}
```

#### 3.3 äº¤äº’å¼æœç´¢æµç¨‹å›¾
ä½¿ç”¨D3.jsæˆ–ç±»ä¼¼åº“åˆ›å»ºå¯äº¤äº’çš„æµç¨‹å›¾ï¼š

```javascript
// åŠ¨æ€æµç¨‹å›¾å±•ç¤º
class SearchFlowVisualization {
  constructor(container) {
    this.svg = d3.select(container).append('svg');
    this.stages = [];
  }

  updateStage(stageName, status, data) {
    const stage = this.svg.select(`#stage-${stageName}`);

    stage.select('.status-indicator')
          .attr('fill', this.getStatusColor(status))
          .attr('class', `status-${status}`);

    if (data) {
      stage.select('.data-preview')
           .text(this.formatPreview(data));
    }
  }

  animateDataFlow(fromStage, toStage, data) {
    // åˆ›å»ºæ•°æ®æµåŠ¨ç”»æ•ˆæœ
    const path = this.svg.select(`#flow-${fromStage}-${toStage}`);
    // æ·»åŠ åŠ¨ç”»é€»è¾‘...
  }
}
```

### **é˜¶æ®µ4: è°ƒè¯•å·¥å…·é›†æˆ (2å¤©)**

#### 4.1 æœç´¢å†å²è®°å½•
```typescript
interface SearchHistory {
  request_id: string;
  query: string;
  timestamp: string;
  duration_ms: number;
  success: boolean;
  result_count: number;
  mode: "criminal_law" | "general_ai";
  tags: string[];  // ç”¨äºåˆ†ç±»å’Œè¿‡æ»¤
}
```

#### 4.2 æ€§èƒ½ç›‘æ§é¢æ¿
```javascript
// å®æ—¶æ€§èƒ½ç›‘æ§
const PerformanceMonitor = {
  data() {
    return {
      realtimeStats: {
        avgResponseTime: 0,
        successRate: 0,
        modulesStatus: {},
        recentQueries: []
      }
    }
  },

  mounted() {
    // WebSocketè¿æ¥è·å–å®æ—¶æ•°æ®
    this.ws = new WebSocket('ws://localhost:5006/debug/realtime');
    this.ws.onmessage = (event) => {
      const stats = JSON.parse(event.data);
      this.updateStats(stats);
    };
  }
}
```

#### 4.3 é”™è¯¯è¿½è¸ªå’ŒæŠ¥è­¦
```python
class DebugAlertSystem:
    """è°ƒè¯•æ¨¡å¼çš„æŠ¥è­¦ç³»ç»Ÿ"""

    def check_module_health(self, trace: ModuleTrace):
        alerts = []

        # æ£€æŸ¥å“åº”æ—¶é—´
        if trace.processing_time_ms > 5000:
            alerts.append(f"{trace.module_name} å“åº”æ—¶é—´è¿‡é•¿: {trace.processing_time_ms}ms")

        # æ£€æŸ¥ç½®ä¿¡åº¦
        if trace.confidence_score and trace.confidence_score < 0.3:
            alerts.append(f"{trace.module_name} ç½®ä¿¡åº¦è¿‡ä½: {trace.confidence_score}")

        # æ£€æŸ¥é”™è¯¯ç‡
        if not trace.success:
            alerts.append(f"{trace.module_name} æ‰§è¡Œå¤±è´¥: {trace.debug_info.get('error_message')}")

        return alerts
```

### **é˜¶æ®µ5: ç”¨æˆ·ä½“éªŒä¼˜åŒ– (2å¤©)**

#### 5.1 æœç´¢æ¨¡å¼åˆ‡æ¢
```html
<!-- ç”¨æˆ·å¯é€‰æ‹©æŸ¥çœ‹çº§åˆ« -->
<div class="view-controls">
  <label>
    <input type="radio" v-model="viewMode" value="simple">
    ç®€å•æ¨¡å¼ - åªçœ‹ç»“æœ
  </label>
  <label>
    <input type="radio" v-model="viewMode" value="process">
    è¿‡ç¨‹æ¨¡å¼ - æ˜¾ç¤ºæœç´¢æ­¥éª¤
  </label>
  <label>
    <input type="radio" v-model="viewMode" value="debug">
    è°ƒè¯•æ¨¡å¼ - å®Œæ•´æŠ€æœ¯ç»†èŠ‚
  </label>
</div>
```

#### 5.2 æ•°æ®å¯¼å‡ºåŠŸèƒ½
```javascript
// å¯¼å‡ºæœç´¢traceç”¨äºç¦»çº¿åˆ†æ
const exportTrace = (requestId) => {
  const trace = getSearchTrace(requestId);
  const blob = new Blob([JSON.stringify(trace, null, 2)],
                       {type: 'application/json'});

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `search-trace-${requestId}.json`;
  a.click();
}
```

---

## ğŸš€ é¢„æœŸæ•ˆæœ

### **ç”¨æˆ·ä½“éªŒæå‡**
- ç”¨æˆ·èƒ½å®æ—¶çœ‹åˆ°"AIåœ¨æ€è€ƒä»€ä¹ˆ"
- å¢å¼ºå¯¹AIæ³•å¾‹åŠ©æ‰‹çš„ä¿¡ä»»åº¦
- ä¸“ä¸šçš„æ³•å¾‹æ£€ç´¢æµç¨‹å±•ç¤º

### **å¼€å‘æ•ˆç‡æå‡**
- å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆå’Œé”™è¯¯æº
- éªŒè¯å„æ¨¡å—çš„æ•°æ®æµæ­£ç¡®æ€§
- ç›‘æ§ç³»ç»Ÿæ•´ä½“å¥åº·çŠ¶å†µ

### **äº§å“å·®å¼‚åŒ–**
- ä¸šå†…é¦–ä¸ªå®Œå…¨é€æ˜çš„AIæ³•å¾‹æ£€ç´¢æµç¨‹
- ä¸“ä¸šçš„æŠ€æœ¯å±•ç¤ºå¢å¼ºäº§å“ç«äº‰åŠ›
- å¯ä½œä¸ºæŠ€æœ¯è¥é”€çš„é‡è¦å–ç‚¹

---

## â±ï¸ å®æ–½æ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | æ—¶é—´ | è´£ä»»äºº |
|------|------|------|--------|
| 1 | æ•°æ®æ ¼å¼è®¾è®¡ä¸è§„èŒƒ | 2å¤© | åç«¯å¼€å‘ |
| 2 | åç«¯APIå¢å¼ºå’Œtraceæ”¶é›† | 3å¤© | åç«¯å¼€å‘ |
| 3 | å‰ç«¯ç•Œé¢å¼€å‘ | 4å¤© | å‰ç«¯å¼€å‘ |
| 4 | è°ƒè¯•å·¥å…·é›†æˆ | 2å¤© | å…¨æ ˆå¼€å‘ |
| 5 | ç”¨æˆ·ä½“éªŒä¼˜åŒ– | 2å¤© | å‰ç«¯å¼€å‘ |

**æ€»è®¡**: 13ä¸ªå·¥ä½œæ—¥ (çº¦2.5å‘¨)

---

## ğŸ”§ æŠ€æœ¯è¦æ±‚

### **åç«¯æŠ€æœ¯æ ˆ**
- FastAPI + WebSocket (å®æ—¶æ•°æ®æ¨é€)
- ç»“æ„åŒ–æ—¥å¿—è®°å½• (JSONæ ¼å¼)
- Redisç¼“å­˜ (å­˜å‚¨traceæ•°æ®)

### **å‰ç«¯æŠ€æœ¯æ ˆ**
- Vue.js 3 + TypeScript
- D3.js (æ•°æ®å¯è§†åŒ–)
- Element Plus (UIç»„ä»¶)
- WebSocketå®¢æˆ·ç«¯

### **å¼€å‘å·¥å…·**
- ç»Ÿä¸€çš„è°ƒè¯•æ¥å£æ ‡å‡†
- è‡ªåŠ¨åŒ–çš„traceæ•°æ®æ”¶é›†
- æ€§èƒ½ç›‘æ§å’ŒæŠ¥è­¦æœºåˆ¶

---

**æ ¸å¿ƒä»·å€¼**: é€šè¿‡å®Œæ•´çš„æœç´¢è¿‡ç¨‹å¯è§†åŒ–ï¼Œè®©"é»‘ç›’"å˜æˆ"é€æ˜ç›’"ï¼Œæ—¢æå‡ç”¨æˆ·ä½“éªŒåˆæ–¹ä¾¿å¼€å‘è°ƒè¯•ï¼Œæ‰“é€ ä¸šå†…é¢†å…ˆçš„AIæ³•å¾‹åŠ©æ‰‹äº§å“ï¼