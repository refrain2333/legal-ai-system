# 前端搜索过程可视化系统 - 完整实施计划

实现AI驱动刑法搜索管道的前端实时可视化，让用户清楚了解搜索过程，方便开发调试。

---

## 🎯 项目目标

### **用户价值**
- **透明化**: 用户能看到AI是如何理解和处理查询的
- **专业性**: 展示法律检索的专业流程
- **信任度**: 通过过程可视化建立用户信任

### **开发价值**
- **调试便利**: 快速定位问题模块和数据异常
- **性能监控**: 实时查看各阶段耗时和成功率
- **数据验证**: 验证每个模块的输入输出正确性

---

## 📋 完整实施计划

### **阶段1: 数据规范设计 (2天)**

#### 1.1 统一数据交付格式
每个模块必须返回标准格式的调试信息：

```typescript
interface ModuleOutput {
  module_name: string;           // 模块名称
  stage: string;                 // 处理阶段
  input_data: any;               // 输入数据
  output_data: any;              // 输出数据
  processing_time_ms: number;    // 处理耗时
  success: boolean;              // 是否成功
  confidence_score?: number;     // 置信度
  debug_info: {                 // 调试信息
    method_used: string;
    fallback_triggered?: boolean;
    error_message?: string;
    internal_steps: string[];
  };
  metadata: {                   // 元数据
    timestamp: string;
    module_version: string;
    config_used: any;
  };
}
```

#### 1.2 完整搜索管道数据格式
设计5阶段完整的数据流：

```typescript
interface SearchPipelineTrace {
  request_id: string;
  user_query: string;
  total_duration_ms: number;

  // 阶段1: LLM分类
  classification: {
    input: string;
    output: {
      is_criminal_law: boolean;
      confidence: number;
      reasoning: string;
      keywords_detected: string[];
    };
    processing_time_ms: number;
    llm_model_used: string;
  };

  // 阶段2: 结构化提取 (仅刑法问题)
  extraction?: {
    input: string;
    output: {
      identified_crimes: Array<{
        crime_name: string;
        confidence: number;
        matched_keywords: string[];
      }>;
      query2doc_enhanced: string;
      hyde_hypothetical: string;
      bm25_keywords: string[];
    };
    processing_time_ms: number;
    crimes_list_version: string;
  };

  // 阶段3: 搜索路由决策
  routing?: {
    input: any;
    output: {
      selected_paths: string[];
      routing_reasoning: string;
      parallel_execution: boolean;
    };
    processing_time_ms: number;
  };

  // 阶段4: 多路搜索执行
  searches?: {
    knowledge_graph?: ModuleOutput;
    llm_enhanced?: ModuleOutput;
    bm25_hybrid?: ModuleOutput;
    basic_semantic?: ModuleOutput;
  };

  // 阶段5: 融合与回答生成
  fusion?: {
    input: any[];
    output: {
      fused_results: any[];
      fusion_algorithm: string;
      confidence_scores: number[];
      final_answer: string;
    };
    processing_time_ms: number;
  };

  // 整体统计
  summary: {
    total_modules_used: number;
    successful_modules: number;
    highest_confidence: number;
    processing_mode: "criminal_law" | "general_ai";
  };
}
```

### **阶段2: 后端API增强 (3天)**

#### 2.1 添加调试模式支持
```python
# 在SearchService中添加
class SearchService:
    def __init__(self, repository: ILegalDocumentRepository, debug_mode: bool = False):
        self.debug_mode = debug_mode
        self.trace_collector = SearchTraceCollector() if debug_mode else None

    async def search_documents_intelligent(self, query: str, debug: bool = False):
        """智能搜索 - 支持调试模式"""
        if debug or self.debug_mode:
            return await self._search_with_full_trace(query)
        else:
            return await self._search_production_mode(query)
```

#### 2.2 每个模块添加trace收集
```python
class LLMClassifier:
    async def classify_query(self, query: str) -> Tuple[dict, ModuleTrace]:
        start_time = time.time()

        # 实际处理逻辑
        result = await self._do_classification(query)

        # 收集trace信息
        trace = ModuleTrace(
            module_name="llm_classifier",
            stage="classification",
            input_data={"query": query},
            output_data=result,
            processing_time_ms=(time.time() - start_time) * 1000,
            success=True,
            debug_info={
                "method_used": "gemini-2.5-flash",
                "internal_steps": ["prompt_construction", "llm_call", "response_parsing"],
                "prompt_tokens": 150,
                "response_tokens": 80
            }
        )

        return result, trace
```

#### 2.3 创建专门的调试API端点
```python
@router.post("/api/search/debug")
async def debug_search(request: DebugSearchRequest):
    """完整调试模式搜索 - 返回详细trace信息"""

@router.post("/api/search/trace/{request_id}")
async def get_search_trace(request_id: str):
    """获取指定搜索的完整trace记录"""

@router.get("/api/debug/modules/status")
async def get_modules_status():
    """获取所有搜索模块的当前状态"""
```

### **阶段3: 前端界面开发 (4天)**

#### 3.1 实时搜索进度展示
创建动态的搜索管道可视化界面：

```html
<!-- 搜索进度条 -->
<div class="search-pipeline">
  <div class="stage" :class="stage1.status">
    <div class="stage-icon">🤖</div>
    <div class="stage-name">问题分类</div>
    <div class="stage-result" v-if="stage1.completed">
      {{ stage1.result.is_criminal_law ? '刑法相关' : '通用问题' }}
    </div>
    <div class="stage-time">{{ stage1.duration }}ms</div>
  </div>

  <!-- 其他阶段... -->
</div>
```

#### 3.2 详细数据查看器
```javascript
// Vue组件 - 数据详情面板
const DebugPanel = {
  data() {
    return {
      searchTrace: null,
      selectedModule: null,
      realTimeMode: true
    }
  },

  methods: {
    async fetchSearchTrace(requestId) {
      const response = await fetch(`/api/search/trace/${requestId}`);
      this.searchTrace = await response.json();
    },

    showModuleDetails(moduleName) {
      this.selectedModule = this.searchTrace.searches[moduleName];
    },

    formatJson(data) {
      return JSON.stringify(data, null, 2);
    }
  }
}
```

#### 3.3 交互式搜索流程图
使用D3.js或类似库创建可交互的流程图：

```javascript
// 动态流程图展示
class SearchFlowVisualization {
  constructor(container) {
    this.svg = d3.select(container).append('svg');
    this.stages = [];
  }

  updateStage(stageName, status, data) {
    const stage = this.svg.select(`#stage-${stageName}`);

    stage.select('.status-indicator')
          .attr('fill', this.getStatusColor(status))
          .attr('class', `status-${status}`);

    if (data) {
      stage.select('.data-preview')
           .text(this.formatPreview(data));
    }
  }

  animateDataFlow(fromStage, toStage, data) {
    // 创建数据流动画效果
    const path = this.svg.select(`#flow-${fromStage}-${toStage}`);
    // 添加动画逻辑...
  }
}
```

### **阶段4: 调试工具集成 (2天)**

#### 4.1 搜索历史记录
```typescript
interface SearchHistory {
  request_id: string;
  query: string;
  timestamp: string;
  duration_ms: number;
  success: boolean;
  result_count: number;
  mode: "criminal_law" | "general_ai";
  tags: string[];  // 用于分类和过滤
}
```

#### 4.2 性能监控面板
```javascript
// 实时性能监控
const PerformanceMonitor = {
  data() {
    return {
      realtimeStats: {
        avgResponseTime: 0,
        successRate: 0,
        modulesStatus: {},
        recentQueries: []
      }
    }
  },

  mounted() {
    // WebSocket连接获取实时数据
    this.ws = new WebSocket('ws://localhost:5006/debug/realtime');
    this.ws.onmessage = (event) => {
      const stats = JSON.parse(event.data);
      this.updateStats(stats);
    };
  }
}
```

#### 4.3 错误追踪和报警
```python
class DebugAlertSystem:
    """调试模式的报警系统"""

    def check_module_health(self, trace: ModuleTrace):
        alerts = []

        # 检查响应时间
        if trace.processing_time_ms > 5000:
            alerts.append(f"{trace.module_name} 响应时间过长: {trace.processing_time_ms}ms")

        # 检查置信度
        if trace.confidence_score and trace.confidence_score < 0.3:
            alerts.append(f"{trace.module_name} 置信度过低: {trace.confidence_score}")

        # 检查错误率
        if not trace.success:
            alerts.append(f"{trace.module_name} 执行失败: {trace.debug_info.get('error_message')}")

        return alerts
```

### **阶段5: 用户体验优化 (2天)**

#### 5.1 搜索模式切换
```html
<!-- 用户可选择查看级别 -->
<div class="view-controls">
  <label>
    <input type="radio" v-model="viewMode" value="simple">
    简单模式 - 只看结果
  </label>
  <label>
    <input type="radio" v-model="viewMode" value="process">
    过程模式 - 显示搜索步骤
  </label>
  <label>
    <input type="radio" v-model="viewMode" value="debug">
    调试模式 - 完整技术细节
  </label>
</div>
```

#### 5.2 数据导出功能
```javascript
// 导出搜索trace用于离线分析
const exportTrace = (requestId) => {
  const trace = getSearchTrace(requestId);
  const blob = new Blob([JSON.stringify(trace, null, 2)],
                       {type: 'application/json'});

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `search-trace-${requestId}.json`;
  a.click();
}
```

---

## 🚀 预期效果

### **用户体验提升**
- 用户能实时看到"AI在思考什么"
- 增强对AI法律助手的信任度
- 专业的法律检索流程展示

### **开发效率提升**
- 快速定位性能瓶颈和错误源
- 验证各模块的数据流正确性
- 监控系统整体健康状况

### **产品差异化**
- 业内首个完全透明的AI法律检索流程
- 专业的技术展示增强产品竞争力
- 可作为技术营销的重要卖点

---

## ⏱️ 实施时间表

| 阶段 | 任务 | 时间 | 责任人 |
|------|------|------|--------|
| 1 | 数据格式设计与规范 | 2天 | 后端开发 |
| 2 | 后端API增强和trace收集 | 3天 | 后端开发 |
| 3 | 前端界面开发 | 4天 | 前端开发 |
| 4 | 调试工具集成 | 2天 | 全栈开发 |
| 5 | 用户体验优化 | 2天 | 前端开发 |

**总计**: 13个工作日 (约2.5周)

---

## 🔧 技术要求

### **后端技术栈**
- FastAPI + WebSocket (实时数据推送)
- 结构化日志记录 (JSON格式)
- Redis缓存 (存储trace数据)

### **前端技术栈**
- Vue.js 3 + TypeScript
- D3.js (数据可视化)
- Element Plus (UI组件)
- WebSocket客户端

### **开发工具**
- 统一的调试接口标准
- 自动化的trace数据收集
- 性能监控和报警机制

---

**核心价值**: 通过完整的搜索过程可视化，让"黑盒"变成"透明盒"，既提升用户体验又方便开发调试，打造业内领先的AI法律助手产品！